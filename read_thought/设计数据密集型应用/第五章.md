### DDIA（5）

#### 复制


本章读完后会了解到**复制的主要作用， 常见的复制模式，不同模式间的优缺点 以及如何来解决这些问题**    

#### 为什么要复制，复制有什么好处？

* 减少用户和服务系统间的延迟
* 由于复制后的数据是多份的，复制后可以提高可用性
* 很多应用的特征是读多写少，可以通过复制来提高吞吐

#### 常见的复制模式

* 主从
* 主主
* 无主

**主从**

这种模式是有一个主数据库，所有的写入会在这个数据库完成。其它的数据库会和主库进行同步，保证数据是最新的。
工作原理是这样子的，当客户端一个请求过来，找到主库，将数据写入主库。然后主库将数据更新到从库。查询的时候
可以只向从库读，减轻主库压力。

这里就牵出一堆问题。 **同步复制与异步复制**

同步复制：

主库在处理用户的请求的时候使用同步复制，在响应返回之前会将数据更新到从库，在从库更新完后才将响应返回给用户。
这种好处显而易见， 从库的数据和主库的相同的，用户从 从库也可以看到最新的数据。如果主库跪了，在从库可以看到
最新的数据。

但是这种方式的坏处也是很致命的，如果由于网络原因 或者是从库跪了主库就无法完成响应。整个服务就卡在了这里，造成
服务不可用。

半同步：

这种方法的思路是将同步和异步混用，在系统中保证有一个从库是同步的， 系统中有两个库是有最新的数据的。

异步复制：

这种方式的好处是系统不会被一个节点给卡主，但是可能会出现数据不一致，主库挂掉 而从库又没有更新数据造成数据丢失。


**添加新的从库**

如何添加新的从库，替换挂掉的节点，保证从库和主库的数据是一致的？

数据的在一直变化的，这就导致数据的副本在不同的时刻是不同的。可以很容易想到，通过将数据库锁起来（禁止写入），来保
证数据是一致的，就像操作系统中对文件进行保护一样。这种方式损失了可用性。

一种方式是 获得数据库的快照，将快照更新到 数据库。

**现在某个从库/主库挂了怎么办？**

从库挂掉：

一方面从库挂掉需要将请求转移到其它节点，另外一方面需要将数据更新到和从库一样的状态上。

主库挂掉：

主库挂掉的话会麻烦很多，需要将一个从库变为主库，并且通知其它从库我现在是主库了。同时当之前挂了的主库恢复后
要知道自己现在变成从库了。  

1. 判断主库挂掉了，这个可以通过超时来判断。如果多久没响应就挂了。
2. 将一个拥有最新数据副本的从库变为主库，这里需要选出一个库，让所有从库认为它是新的主库。
3. 将客户端的请求变更到新的主库上，并且之前的主库恢复后要明白自己变成了从库。

在故障转移的时候也会有很多问题：

1. 使用异步复制的时候，新的库可能会丢一些数据。当老的主库重新加入后可能有冲突的请求。
2. 数据库和其它系统有耦合， 作者在这里举了一个github的例子，一个旧的从库被提升为主库， 
    这个从库的数据和主库的数据是不同步的，数据库用自增id为主键，在使用了新的主库后，重用
    了一些已经用过的主键，这些主键在redis中被使用，这就导致那些被用过的主键可以从redis中
    获取其它用户的隐私数据。

3. 主库失效时间要如何权衡？ 时间太短可能会有很多不必要的故障转移，如果时间太长 可能导致恢复时间也变长
   

**复制日志**

**基于语句的复制**

将语句转发到从库，可能出现的问题是 语句中使用了一些 "变量"（比如 当前时间戳）， 或者语句中的数据是有依赖的（自增id）。 

* 传输预写式日志

在任何一种情况下，日志都是包含所有数据库写入的仅追加字节序列。可以使用完全相同的日志在另一个节点上构建副本：    
除了将日志写入磁盘之外，主库还可以通过网络将其发送给其从库。这种方式是和存储引擎耦合的。

当从库应用这个日志时，它会建立和主库一模一样数据结构的副本。

* 逻辑日志复制   

复制 和 存储引擎使用不同的格式，将数据和存储引擎解耦。    

#### 复制延迟

对使用异步复制系统进行扩展的时候只需要添加从节点就可以，但是数据会不一致。使用同步的时候可能会在一个节点block掉整个系统

写后读：  

一种场景是 用户更新自己的签名，更新后想立马看到，但是其他用户不需要立马看到。

对于这种情况当用户提交数据的时候提交到主库，查看的时候可以也直接从主库读取。这种情况只适用于用户只编辑少部分内容的情况。
另一种方式是通过一个逻辑时间戳来保证，在客户端这里保存最后一次写入的时间戳，用这个来进行对比。

还需要考虑的几点是：   

用了多个数据中心，请求需要路由到主库的数据中心。
在跨设备请求中间保证一致。这种情况下时间戳的方法是无法使用的。并且在多个数据中心的情况下不同的设备路由到一个数据中心会很麻烦。









































