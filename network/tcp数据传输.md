#### tcp头部  

以太网首部 - IP首部 - TCP首部 - 应用数据

首先来明确下tcp要做的一些事情，从上面这句话可以看到是一层层封装的。在网络层次结构中，只需要关心  
上层和自己临近的一层。ip层为我们提供了主机和主机间的不可靠链接。 tcp需要提供的就是应用进程间的可靠  
链接。 为了提供具体的应用进程间的链接，使用了16位的端口号。（A的ip，端口， B的ip，端口）构成了一个四元组  
用来标识唯一的一个链接。 由于tcp是面向流的，tcp用32位的序列号和确认号 来标识。 用4位来标识首部长度  
还需要几位的标志位 来标识各种状态。 tcp是可以控制流量的，这个靠窗口来实现。 并且tcp是要对整个报文进行校验的  
以上就是tcp中主要要了解到的字段。 

![tcp头](http://pyblog-10073407.image.myqcloud.com/postimage1511277046)

#### tcp可靠传输原理  
简单来说tcp的可靠传输就是请求确认。但是这种方式的效率太低了，在tcp中通过滑动窗口的机制进行了一个高效  
数据传输

![win](http://pyblog-10073407.image.myqcloud.com/postimage1511616411?imageView2/0/w/450/h/400)  

如上图  
当窗口从左边沿向右靠近的时候，窗口合拢。这种现象发生在数据被发送和确认时。  
当窗口从右边沿向右移动，允许发送更多的数据。这种现象是接收方已经确认了数据，并释放了接收的缓存。  
当左边沿向左移动，这个是窗口收缩。很少有人这样子用。    

![wincontrol](http://pyblog-10073407.image.myqcloud.com/postimage1512484879?imageView2/0/w/450/h/400)  

tcp是一个全双工的协议，在两端都需要维护序号。  
一个有效的需要要满足  
snd_una < 确认序号 <= snd_max    
通过维持序号来保证两端的状态。  

#### push标志  
之前分析一个网络包的时候发现所有的网络包都有push标志。这个标志的含义是尽快把数据  
交给应用处理。 不加这个的话可能导致数据在缓存中待一段时间，这对于有实时性要求的应用来说  
是一个不好的机制。所以就通过push标志来解决。
  
#### tcp 拥塞控制  

发送窗口的上限 min[rwnd, cwnd] 选取拥塞窗口和接收窗口的的最小值。  
rwnd > cwnd的时候， 证明当前网络是主要瓶颈  
反之代表 接收方的接收能力是主要瓶颈。  

##### 慢启动和拥塞避免

当一个tcp链接建立的时候，该链接的cwnd先被置为1，然后变为2，经过每一个传输轮次cwnd进行指数增大。  
到达一个点的时候数据就开始出现丢包（这里的丢包包括 拥塞丢包和错误丢包）。 这是就通知发送方，  
将窗口变小。  

拥塞避免算法是cwnd每一个传输轮次加1（这里用1是为了理解，实际上cwnd是以字节为单位），而不是指数级别的  
增加。上面的算法之所以叫慢开始算法的原因是因为cwnd是从1开始的，而不是说增长的慢。  


这里还要有一个慢开始门限，用法如下：  
    
    cwnd<ssthresh 慢开始算法  
    cwnd==ssthresh 慢开始 或者 拥塞避免
    cwnd>ssthresh 拥塞避免

#### 传播时延 和 发送时延  

传播时延主要是光速，传输设备等待时间，主要和距离有关系。  
发送时延主要是看带宽。  

带宽越大 传播时延影响就越大，反之则是发送时延影响大。  

**带宽时延乘积**  
把网络想像成一个水管，水管中可以容纳的谁的多少就是水管截面大小*水管长度。  
在网络中这个长度就是rtt，截面就是带宽。  

**长肥管道**  



**拥塞**  
当数据在一个大的管道进入一个小管道就会出现阻塞。


#### bbr算法










#### 什么时候用tcp 什么时候用udp？  

实时性，公平性，带宽 这三点是无法同时满足的。  
UDP也可以实现可靠传输，这种方式放弃了公平性（没有拥塞控制）增加了实时性（不需要三次握手  
来建立链接。）  
在实时性要求高的场合使用udp比较好，比如实时聊天。  
其它一些场合使用tcp，tcp是可以充分利用带宽的。比如 传输文件。。。